{% extends "base.html" %}
{% load pack_extras %}
{% block title %}{{ pack.name }}{% endblock %}

{% block content %}
  <div class="pack-header card neon-card">
    <div class="pack-header__top">
      <h2 class="neon-title">{{ pack.name }}</h2>
      <p class="pack-sub">Creado el {{ pack.creation_date|date:"d/m/Y H:i" }}</p>
    </div>

    <div class="pack-meta-row">
      {% with label=pack.get_category_display %}
        <span class="pill pill-ghost">
          <span class="pill-emoji">{{ label|slice:":2" }}</span>
          <span class="pill-text">{{ label|slice:"2:" }}</span>
        </span>
      {% endwith %}

      <span class="pill">
        {% stars pack.level 5 %}
      </span>
    </div>

    <div class="pack-meta-row">
      <a class="btn btn-secondary btn-sm" href="{% url 'pack_edit' pack.pk %}">
        ‚úèÔ∏è Editar pack
      </a>
      <a class="btn btn-ghost btn-sm" href="{% url 'dashboard' %}">‚Üê Volver a mis packs</a>
    </div>
  </div>

  <!-- COMPARTIR PACK (solo due√±o) -->
  {% if user == pack.owner %}
  <div class="card neon-card share-box">
    <h3>Compartir pack</h3>

    <form method="post" action="{% url 'add_collaborator' pack.pk %}" class="form-grid">
      {% csrf_token %}
      {% if form_add_collab.non_field_errors %}
        <div class="form-errors">
          {{ form_add_collab.non_field_errors }}
        </div>
      {% endif %}

      <div class="form-row">
        <label for="{{ form_add_collab.username.id_for_label }}">Usuario</label>
        {{ form_add_collab.username }}
        {% if form_add_collab.username.help_text %}
          <div class="muted" style="margin-top:6px;">{{ form_add_collab.username.help_text }}</div>
        {% endif %}
        {{ form_add_collab.username.errors }}
      </div>

      <div class="form-row">
        <label for="{{ form_add_collab.role.id_for_label }}">Rol</label>
        {{ form_add_collab.role }}
        {% if form_add_collab.role.help_text %}
          <div class="muted" style="margin-top:6px;">{{ form_add_collab.role.help_text }}</div>
        {% endif %}
        {{ form_add_collab.role.errors }}
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" style="margin: 0 auto; display: block;">Conceder acceso</button>
      </div>
    </form>

    <h4>Colaboradores</h4>
    {% for c in collaborators %}
      <div class="collab-row">
      <span class="collab-user">{{ c.user.username }}</span>
      <span class="sep">-</span>
      <span class="collab-role">{{ c.get_role_display }}</span>
      <span class="sep">-</span>
      <a class="collab-remove"
         href="{% url 'remove_collaborator' pack.pk c.user.pk %}"
         onclick="return confirm('¬øQuitar acceso a @{{ c.user.username }}?');">
        Quitar
      </a>
    </div>
    {% empty %}
      <span class="muted">Sin colaboradores a√∫n.</span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ACCIONES DEL PACK -->
  <div class="card neon-card pack-detail">
    <h3>Acciones del pack</h3>

    <!-- VERDAD -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-truth">Verdad</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'verdad' %}">+ A√±adir Verdad</a>
      </summary>

      {% if verdades %}
        <ul class="list-clean">
          {% for a in verdades %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay verdades todav√≠a.</p>
      {% endif %}
    </details>

    <!-- RETO -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-dare">Reto</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'reto' %}">+ A√±adir Reto</a>
      </summary>

      {% if retos %}
        <ul class="list-clean">
          {% for a in retos %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay retos todav√≠a.</p>
      {% endif %}
    </details>
  </div>

  {# ====== COMPARTIR Y JUGAR ====== #}
  {% url 'publico_por_token' pack.token as public_path %}
  {% with full_public_url=request.scheme|add:"://"|add:request.get_host|add:public_path %}

  <div class="card neon-card share-panel">
    <h3 class="share-title">Compartir y jugar</h3>

    <p class="share-sub">
      Comparte el enlace y juega al instante.
    </p>

    <div class="share-link-row">
      <a class="url-badge share-url" id="publicLink"
        href="{{ public_path }}"
        target="_blank" rel="noopener">
        {{ full_public_url }}
      </a>

      <button type="button" class="icon-btn share-copy"
              onclick="copyPublicLink()"
              aria-label="Copiar enlace">
        <span aria-hidden="true">üìã</span>
      </button>
    </div>

    <section class="share-actions-grid" aria-label="Acciones del pack">
      <!-- Jugar -->
      <a href="{{ public_path }}" class="action-card neon-card" aria-label="Jugar">
        <div class="action-card__emoji" aria-hidden="true">üéÆ</div>
        <div class="action-card__title">Jugar</div>
        <div class="action-card__hint">Abrir la vista p√∫blica</div>
      </a>

      <!-- Descargar QR -->
      <a href="{% url 'qr_image' pack.pk %}" class="action-card neon-card" aria-label="Descargar QR">
        <div class="action-card__emoji" aria-hidden="true">üî≥</div>
        <div class="action-card__title">Descargar QR</div>
        <div class="action-card__hint">Para compartir r√°pido</div>
      </a>

      <!-- Regenerar enlace (POST) -->
      <form method="post" action="{% url 'link_regenerate' pack.pk %}" class="action-form">
        {% csrf_token %}
        <button type="submit"
                class="action-card neon-card action-card--danger"
                onclick="return confirm('¬øRegenerar enlace del pack? El anterior dejar√° de funcionar.')"
                aria-label="Regenerar enlace">
          <div class="action-card__emoji" aria-hidden="true">üîÅ</div>
          <div class="action-card__title">Regenerar enlace</div>
          <div class="action-card__hint">El anterior dejar√° de funcionar</div>
        </button>
      </form>

      <!-- Crear sala online -->
      <a href="{% url 'room_create' pack.id %}" class="action-card neon-card" aria-label="Crear sala online">
        <div class="action-card__emoji" aria-hidden="true">üåê</div>
        <div class="action-card__title">Crear sala online</div>
        <div class="action-card__hint">Jugar en grupo en directo</div>
      </a>
    </section>

    <p class="share-toast" id="copyToast" role="status" aria-live="polite"></p>
  </div>

  <script>
    function copyPublicLink() {
      const text = document.getElementById("publicLink").textContent.trim();
      const toast = document.getElementById("copyToast");

      const done = () => {
        toast.textContent = "‚úÖ Enlace copiado";
        toast.classList.add("is-visible");
        setTimeout(() => toast.classList.remove("is-visible"), 1600);
      };

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(done).catch(() => fallbackCopy(text, done));
      } else {
        fallbackCopy(text, done);
      }

      function fallbackCopy(t, cb) {
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); } catch(e) {}
        document.body.removeChild(ta);
        cb();
      }
    }
  </script>

  {% endwith %}
{% endblock %}