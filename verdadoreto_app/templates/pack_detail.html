{% extends "base.html" %}
{% load pack_extras %}
{% block title %}{{ pack.name }}{% endblock %}

{% block content %}
  <div class="pack-header card neon-card">
    <div class="pack-header__top">
      <h2 class="neon-title">{{ pack.name }}</h2>
      <p class="pack-sub">Creado el {{ pack.creation_date|date:"d/m/Y H:i" }}</p>
    </div>

    <div class="pack-meta-row">
      {% with label=pack.get_category_display %}
        <span class="pill pill-ghost">
          <span class="pill-emoji">{{ label|slice:":2" }}</span>
          <span class="pill-text">{{ label|slice:"2:" }}</span>
        </span>
      {% endwith %}

      <span class="pill">
        {% stars pack.level 5 %}
      </span>
    </div>

    <div class="pack-meta-row">
      <a class="btn btn-secondary btn-sm" href="{% url 'pack_edit' pack.pk %}">
        ‚úèÔ∏è Editar pack
      </a>
      <a class="btn btn-ghost btn-sm" href="{% url 'dashboard' %}">‚Üê Volver a mis packs</a>
    </div>
  </div>

  <!-- COMPARTIR PACK (solo due√±o) -->
  {% if user == pack.owner %}
  <div class="card neon-card share-box">
    <h3>Compartir pack</h3>

    <form method="post" action="{% url 'add_collaborator' pack.pk %}" class="form-grid">
      {% csrf_token %}
      {% if form_add_collab.non_field_errors %}
        <div class="form-errors">
          {{ form_add_collab.non_field_errors }}
        </div>
      {% endif %}

      <div class="form-row">
        <label for="{{ form_add_collab.username.id_for_label }}">Usuario</label>
        {{ form_add_collab.username }}
        {% if form_add_collab.username.help_text %}
          <div class="muted" style="margin-top:6px;">{{ form_add_collab.username.help_text }}</div>
        {% endif %}
        {{ form_add_collab.username.errors }}
      </div>

      <div class="form-row">
        <label for="{{ form_add_collab.role.id_for_label }}">Rol</label>
        {{ form_add_collab.role }}
        {% if form_add_collab.role.help_text %}
          <div class="muted" style="margin-top:6px;">{{ form_add_collab.role.help_text }}</div>
        {% endif %}
        {{ form_add_collab.role.errors }}
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" style="margin: 0 auto; display: block;">Conceder acceso</button>
      </div>
    </form>

    <h4>Colaboradores</h4>
    {% for c in collaborators %}
      <div class="collab-row">
      <span class="collab-user">{{ c.user.username }}</span>
      <span class="sep">-</span>
      <span class="collab-role">{{ c.get_role_display }}</span>
      <span class="sep">-</span>
      <a class="collab-remove"
         href="{% url 'remove_collaborator' pack.pk c.user.pk %}"
         onclick="return confirm('¬øQuitar acceso a @{{ c.user.username }}?');">
        Quitar
      </a>
    </div>
    {% empty %}
      <span class="muted">Sin colaboradores a√∫n.</span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ACCIONES DEL PACK -->
  <div class="card neon-card pack-detail">
    <h3>Acciones del pack</h3>

    <!-- VERDAD -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-truth">Verdad</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'verdad' %}">+ A√±adir Verdad</a>
      </summary>

      {% if verdades %}
        <ul class="list-clean">
          {% for a in verdades %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay verdades todav√≠a.</p>
      {% endif %}
    </details>

    <!-- RETO -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-dare">Reto</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'reto' %}">+ A√±adir Reto</a>
      </summary>

      {% if retos %}
        <ul class="list-clean">
          {% for a in retos %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay retos todav√≠a.</p>
      {% endif %}
    </details>
  </div>

    <!-- ENLACE P√öBLICO (TOKEN √öNICO) -->
  <div class="card neon-card public-links">
    <h3>Compartir y jugar</h3>

    <div class="public-block">
      <p class="link-line" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <strong>Comparte el enlace y juega al instante</strong>

        <a class="url-badge" id="link-pack" href="{% url 'publico_por_token' pack.token %}">
          {% url 'publico_por_token' pack.token %}
        </a>

        <button type="button" class="icon-btn" id="copy-pack-link" title="Copiar enlace" aria-label="Copiar enlace">
          üìã
        </button>
      </p>

      <!-- 4 tarjetas, estilo "Mis packs" -->
      <section class="packs-grid" aria-label="Acciones de enlace p√∫blico" style="margin-top:14px;">
        <!-- Jugar -->
        <div class="pack-card-wrap" style="position:relative;">
          <a href="{% url 'publico_por_token' pack.token %}" class="pack-card neon-card" aria-label="Jugar">
            <header class="pack-card__head">
              <h3 class="pack-card__title">Jugar</h3>
            </header>
            <div class="pack-card__emoji">üéÆ</div>
            <div class="pack-card__level">
              <span class="stars muted">Abrir pack</span>
            </div>
          </a>
        </div>

        <!-- Descargar QR -->
        <div class="pack-card-wrap" style="position:relative;">
          <a href="{% url 'qr_image' pack.pk %}" class="pack-card neon-card" aria-label="Descargar QR">
            <header class="pack-card__head">
              <h3 class="pack-card__title">QR</h3>
            </header>
            <div class="pack-card__emoji">üì∑</div>
            <div class="pack-card__level">
              <span class="stars muted">Descargar</span>
            </div>
          </a>
        </div>

        <!-- Regenerar enlace (POST) -->
        <div class="pack-card-wrap" style="position:relative;">
          <form method="post" action="{% url 'link_regenerate' pack.pk %}"
                onsubmit="return confirm('¬øRegenerar enlace del pack? El anterior dejar√° de funcionar.');">
            {% csrf_token %}
            <button type="submit" class="pack-card neon-card" style="cursor:pointer; width:100%; border:0;">
              <header class="pack-card__head">
                <h3 class="pack-card__title">Regenerar</h3>
              </header>
              <div class="pack-card__emoji">üîÅ</div>
              <div class="pack-card__level">
                <span class="stars muted">Nuevo enlace</span>
              </div>
            </button>
          </form>
        </div>

        <!-- Sala online -->
        <div class="pack-card-wrap" style="position:relative;">
          <a href="{% url 'room_create' pack.id %}" class="pack-card neon-card" aria-label="Crear Sala Online">
            <header class="pack-card__head">
              <h3 class="pack-card__title">Sala</h3>
            </header>
            <div class="pack-card__emoji">üé•</div>
            <div class="pack-card__level">
              <span class="stars muted">Crear online</span>
            </div>
          </a>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function () {
      const btn = document.getElementById('copy-pack-link');
      const linkEl = document.getElementById('link-pack');
      if (!btn || !linkEl) return;

      btn.addEventListener('click', async () => {
        try {
          // Si tu <a> muestra ruta relativa, copiamos URL absoluta:
          const url = new URL(linkEl.getAttribute('href'), window.location.origin).toString();
          await navigator.clipboard.writeText(url);
          btn.classList.add('is-active');
          setTimeout(() => btn.classList.remove('is-active'), 700);
        } catch (e) {
          // fallback simple
          window.prompt("Copia el enlace:", linkEl.href);
        }
      });
    })();
  </script>

{% endblock %}