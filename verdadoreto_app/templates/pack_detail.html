{% extends "base.html" %}
{% load pack_extras %}
{% block title %}{{ pack.name }}{% endblock %}

{% block content %}
  <div class="pack-header card neon-card">
    <div class="pack-header__top">
      <h2 class="neon-title">{{ pack.name }}</h2>
      <p class="pack-sub">Creado el {{ pack.creation_date|date:"d/m/Y H:i" }}</p>
    </div>

    <div class="pack-meta-row">
      {% with label=pack.get_category_display %}
        <span class="pill pill-ghost">
          <span class="pill-emoji">{{ label|slice:":2" }}</span>
          <span class="pill-text">{{ label|slice:"2:" }}</span>
        </span>
      {% endwith %}

      <span class="pill">
        {% stars pack.level 5 %}
      </span>
    </div>

    <div class="pack-meta-row">
      <a class="btn btn-secondary btn-sm" href="{% url 'pack_edit' pack.pk %}">
        ‚úèÔ∏è Editar pack
      </a>
      <a class="btn btn-ghost btn-sm" href="{% url 'dashboard' %}">‚Üê Volver a mis packs</a>
    </div>
  </div>

  <!-- COMPARTIR PACK (solo due√±o) -->
  {% if user == pack.owner %}
  <div class="card neon-card share-box">
    <h3>Compartir pack</h3>

    <form method="post" action="{% url 'add_collaborator' pack.pk %}" class="form-grid">
      {% csrf_token %}
      {% if form_add_collab.non_field_errors %}
        <div class="form-errors">
          {{ form_add_collab.non_field_errors }}
        </div>
      {% endif %}

      <div class="form-row">
        <label for="{{ form_add_collab.username.id_for_label }}">Usuario</label>
        {{ form_add_collab.username }}
        {% if form_add_collab.username.help_text %}
          <div class="muted" style="margin-top:6px;">{{ form_add_collab.username.help_text }}</div>
        {% endif %}
        {{ form_add_collab.username.errors }}
      </div>

      <div class="form-row">
        <label for="{{ form_add_collab.role.id_for_label }}">Rol</label>
        {{ form_add_collab.role }}
        {% if form_add_collab.role.help_text %}
          <div class="muted" style="margin-top:6px;">{{ form_add_collab.role.help_text }}</div>
        {% endif %}
        {{ form_add_collab.role.errors }}
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" style="margin: 0 auto; display: block;">Conceder acceso</button>
      </div>
    </form>

    <h4>Colaboradores</h4>
    {% for c in collaborators %}
      <div class="collab-row">
      <span class="collab-user">{{ c.user.username }}</span>
      <span class="sep">-</span>
      <span class="collab-role">{{ c.get_role_display }}</span>
      <span class="sep">-</span>
      <a class="collab-remove"
         href="{% url 'remove_collaborator' pack.pk c.user.pk %}"
         onclick="return confirm('¬øQuitar acceso a @{{ c.user.username }}?');">
        Quitar
      </a>
    </div>
    {% empty %}
      <span class="muted">Sin colaboradores a√∫n.</span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ACCIONES DEL PACK -->
  <div class="card neon-card pack-detail">
    <h3>Acciones del pack</h3>

    <!-- VERDAD -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-truth">Verdad</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'verdad' %}">+ A√±adir Verdad</a>
      </summary>

      {% if verdades %}
        <ul class="list-clean">
          {% for a in verdades %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay verdades todav√≠a.</p>
      {% endif %}
    </details>

    <!-- RETO -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-dare">Reto</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'reto' %}">+ A√±adir Reto</a>
      </summary>

      {% if retos %}
        <ul class="list-clean">
          {% for a in retos %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay retos todav√≠a.</p>
      {% endif %}
    </details>
  </div>

  <!-- SECCI√ìN COMPARTIR -->
  <div class="card neon-card pack-share">
    <h3 class="pack-share__title">Compartir y jugar</h3>

    <div class="pack-share__panel">
      <!-- Barra superior: texto + copiar (una sola l√≠nea) -->
      <div class="pack-share__topbar" aria-label="Copiar enlace del pack">
        <strong class="pack-share__toptext">Comparte el enlace y juega al instante</strong>

        <button type="button"
                class="icon-btn pack-share__copybtn"
                id="copy-pack-link"
                title="Copiar enlace"
                aria-label="Copiar enlace">
          üìã
        </button>
      </div>

      <!-- 4 tarjetas -->
      <section class="pack-share-grid" aria-label="Acciones para jugar y compartir">
        <!-- Jugar -->
        <a href="{% url 'publico_por_token' pack.token %}"
          class="pack-share-card neon-card"
          aria-label="Jugar">
          <header class="pack-share-card__head">
            <h4 class="pack-share-card__title">Jugar</h4>
          </header>
          <div class="pack-share-card__emoji" aria-hidden="true">‚ñ∂Ô∏è</div>
          <div class="pack-share-card__foot">
            <span class="pack-share-card__hint">Abrir pack</span>
          </div>
        </a>

        <!-- Descargar QR -->
        <a href="{% url 'qr_image' pack.pk %}"
          class="pack-share-card neon-card"
          aria-label="Descargar QR">
          <header class="pack-share-card__head">
            <h4 class="pack-share-card__title">QR</h4>
          </header>
          <div class="pack-share-card__emoji" aria-hidden="true">üì∑</div>
          <div class="pack-share-card__foot">
            <span class="pack-share-card__hint">Descargar QR</span>
          </div>
        </a>

        <!-- Regenerar enlace (POST) -->
        <form method="post"
              action="{% url 'link_regenerate' pack.pk %}"
              class="pack-share-form"
              onsubmit="return confirm('¬øRegenerar enlace del pack? El anterior dejar√° de funcionar.');">
          {% csrf_token %}
          <button type="submit" class="pack-share-card neon-card pack-share-card--danger">
            <header class="pack-share-card__head">
              <h4 class="pack-share-card__title">Regenerar</h4>
            </header>
            <div class="pack-share-card__emoji" aria-hidden="true">üîÅ</div>
            <div class="pack-share-card__foot">
              <span class="pack-share-card__hint">Nuevo enlace</span>
            </div>
          </button>
        </form>

        <!-- Sala online -->
        <a href="{% url 'room_create' pack.id %}"
          class="pack-share-card neon-card"
          aria-label="Crear sala online">
          <header class="pack-share-card__head">
            <h4 class="pack-share-card__title">Sala</h4>
          </header>
          <div class="pack-share-card__emoji" aria-hidden="true">üé•</div>
          <div class="pack-share-card__foot">
            <span class="pack-share-card__hint">Crear sala online</span>
          </div>
        </a>
      </section>

      <p class="pack-share__toast" id="packShareToast" role="status" aria-live="polite"></p>
    </div>
  </div>

  <script>
    (function () {
      const btn = document.getElementById('copy-pack-link');
      const linkEl = document.getElementById('share-link');
      const toast = document.getElementById('packShareToast');
      if (!btn || !linkEl) return;

      function showToast(msg){
        if(!toast) return;
        toast.textContent = msg;
        toast.classList.add('is-visible');
        setTimeout(() => toast.classList.remove('is-visible'), 1400);
      }

      btn.addEventListener('click', async () => {
        try {
          const url = new URL(linkEl.getAttribute('href'), window.location.origin).toString();
          await navigator.clipboard.writeText(url);
          btn.classList.add('is-active');
          setTimeout(() => btn.classList.remove('is-active'), 700);
          showToast("‚úÖ Enlace copiado");
        } catch (e) {
          // fallback simple
          const fallbackUrl = new URL(linkEl.getAttribute('href'), window.location.origin).toString();
          window.prompt("Copia el enlace:", fallbackUrl);
        }
      });
    })();
  </script>


{% endblock %}