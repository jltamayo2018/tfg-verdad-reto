{% extends "base.html" %}
{% load pack_extras %}
{% block title %}{{ pack.name }}{% endblock %}

{% block content %}
  <div class="pack-header card neon-card">
    <div class="pack-header__top">
      <h2 class="neon-title">{{ pack.name }}</h2>
      <p class="pack-sub">Creado el {{ pack.creation_date|date:"d/m/Y H:i" }}</p>
    </div>

    <div class="pack-meta-row">
      {% with label=pack.get_category_display %}
        <span class="pill pill-ghost">
          <span class="pill-emoji">{{ label|slice:":2" }}</span>
          <span class="pill-text">{{ label|slice:"2:" }}</span>
        </span>
      {% endwith %}

      <span class="pill">
        {% stars pack.level 5 %}
      </span>
    </div>

    <div class="pack-meta-row">
      <a class="btn btn-secondary btn-sm" href="{% url 'pack_edit' pack.pk %}">
        ‚úèÔ∏è Editar pack
      </a>
      <a class="btn btn-ghost btn-sm" href="{% url 'dashboard' %}">‚Üê Volver a mis packs</a>
    </div>
  </div>

  <!-- COMPARTIR PACK (solo due√±o) -->
  {% if user == pack.owner %}
  <div class="card neon-card share-box">
    <h3>Compartir pack</h3>

    <form method="post" action="{% url 'add_collaborator' pack.pk %}" class="form-grid">
      {% csrf_token %}
      {% if form_add_collab.non_field_errors %}
        <div class="form-errors">
          {{ form_add_collab.non_field_errors }}
        </div>
      {% endif %}

      <div class="form-row">
        <label for="{{ form_add_collab.username.id_for_label }}">Usuario</label>
        {{ form_add_collab.username }}
        {{ form_add_collab.username.errors }}
      </div>

      <div class="form-row">
        <label for="{{ form_add_collab.role.id_for_label }}">Rol</label>
        {{ form_add_collab.role }}
        {{ form_add_collab.role.errors }}
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" style="margin: 0 auto; display: block;">Conceder acceso</button>
      </div>
    </form>

    <h4>Colaboradores</h4>
    {% for c in collaborators %}
      <div class="collab-row">
      <span class="collab-user">{{ c.user.username }}</span>
      <span class="sep">-</span>
      <span class="collab-role">{{ c.get_role_display }}</span>
      <span class="sep">-</span>
      <a class="collab-remove"
         href="{% url 'remove_collaborator' pack.pk c.user.pk %}"
         onclick="return confirm('¬øQuitar acceso a @{{ c.user.username }}?');">
        Quitar
      </a>
    </div>
    {% empty %}
      <span class="muted">Sin colaboradores a√∫n.</span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ACCIONES DEL PACK -->
  <div class="card neon-card pack-detail">
    <h3>Acciones del pack</h3>

    <!-- VERDAD -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-truth">Verdad</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'verdad' %}">+ A√±adir Verdad</a>
      </summary>

      {% if verdades %}
        <ul class="list-clean">
          {% for a in verdades %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay verdades todav√≠a.</p>
      {% endif %}
    </details>

    <!-- RETO -->
    <details class="accordion">
      <summary class="accordion-header">
        <span class="chip chip-dare">Reto</span>
        <a class="btn btn-primary btn-sm" href="{% url 'action_create' pack.pk 'reto' %}">+ A√±adir Reto</a>
      </summary>

      {% if retos %}
        <ul class="list-clean">
          {% for a in retos %}
            <li class="action-item">
              <div class="action-text">
                {% if not a.active %}
                  <span class="badge badge-inactive">(inactiva)</span>
                {% endif %}
                {{ a.text|default:"(sin texto)" }}
              </div>

              <div class="action-tools">
                <a class="icon-btn" href="{% url 'action_edit' pack.pk a.pk %}" title="Editar" aria-label="Editar">‚úèÔ∏è</a>

                <form method="post" action="{% url 'action_toggle' pack.pk a.pk %}" class="inline">
                  {% csrf_token %}
                  <button type="submit"
                          class="icon-btn"
                          title="{% if a.active %}Desactivar{% else %}Activar{% endif %}"
                          aria-label="{% if a.active %}Desactivar{% else %}Activar{% endif %}">
                    {% if a.active %}‚õî{% else %}‚úÖ{% endif %}
                  </button>
                </form>

                <a class="icon-btn danger" href="{% url 'action_delete' pack.pk a.pk %}" title="Borrar" aria-label="Borrar">üóëÔ∏è</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No hay retos todav√≠a.</p>
      {% endif %}
    </details>
  </div>

  <!-- ENLACE P√öBLICO (TOKEN √öNICO) -->
  <div class="card neon-card public-links">
    <h3>Enlace p√∫blico</h3>

    <div class="public-block">
      <p class="link-line">
        <strong>URL del pack:</strong>
        <a class="url-badge" id="link-pack" href="{% url 'publico_por_token' pack.token %}">
          {% url 'publico_por_token' pack.token %}
        </a>
      </p>

      <!-- Botonera responsive en grid -->
      <div class="btn-grid">
        <a class="btn btn-secondary" href="{% url 'publico_por_token' pack.token %}">Jugar</a>
        <a class="btn btn-primary"   href="{% url 'qr_image' pack.pk %}">Descargar QR</a>

        <!-- El de regenerar es POST: lo metemos en la misma grid -->
        <form method="post" action="{% url 'link_regenerate' pack.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary"
                  onclick="return confirm('¬øRegenerar enlace del pack? El anterior dejar√° de funcionar.')">
            Regenerar enlace √∫nico
          </button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}