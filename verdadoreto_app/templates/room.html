{% extends "base.html" %}
{% block title %}Sala {{ room.code }}{% endblock %}

{% block content %}

<div class="container room-layout">

  <!-- VIDEO -->
  <div class="room-video">
    <div id="jitsi"></div>
  </div>

  <!-- PANEL DERECHA / ABAJO -->
  <aside class="neon-card room-panel">

    <!-- COPIAR ENLACE (MISMA L√çNEA + ICONO üìã) -->
    <div class="room-share-row">
      <span class="room-share__label">Copiar c√≥digo sala ‚Üí</span>
      <button type="button" id="btn-copy-link" class="btn-icon" aria-label="Copiar enlace">
        <span class="btn-icon__emoji">üìã</span>
      </button>
    </div>

    <p><strong>Tem√°tica:</strong> {{ pack.name }}</p>
    <p><strong>Estado:</strong> <span id="room-status">{{ room.status }}</span></p>

    {% if is_host %}
      <button id="btn-start" class="btn btn-primary" {% if room.status != "lobby" %}disabled{% endif %}>
        Iniciar juego
      </button>

      <div class="room-nav-buttons">
        <button id="btn-truth" class="btn btn-secondary" disabled>Verdad</button>
        <button id="btn-dare"  class="btn btn-secondary" disabled>Reto</button>
      </div>
    {% endif %}

    <hr>

    <h3>Pregunta actual</h3>
    <div id="question-box" class="neon-card room-question-box">
      <span class="question-text">(A la espera de iniciar‚Ä¶)</span>
    </div>

  </aside>
</div>

<!-- JITSI (JaaS) -->
<script src="https://8x8.vc/external_api.js"></script>

<script>
  /* -------------------------
     JITSI (JaaS + JWT)
  -------------------------- */
  const domain = "8x8.vc";

  // En JaaS el roomName debe incluir el AppID como prefijo
  const roomName = "{{ jitsi_app_id }}/{{ room.code }}";

  const api = new JitsiMeetExternalAPI(domain, {
    roomName,
    parentNode: document.getElementById("jitsi"),

    jwt: "{{ jitsi_token|escapejs }}",

    userInfo: { displayName: "{{ display_name|escapejs }}" },

    configOverwrite: {
      prejoinConfig: { enabled: true },
      startAudioMuted: 1,
      startVideoMuted: 1,
    },

    interfaceConfigOverwrite: {
      DISABLE_JOIN_LEAVE_NOTIFICATIONS: false,
    }
  });

  /* -------------------------
     DATOS SERVER ‚Üí JS
  -------------------------- */
  const isHost    = JSON.parse('{{ is_host|yesno:"true,false"|escapejs }}');
  const questions = JSON.parse('{{ questions_json|escapejs }}');

  // Precalcular √≠ndices por tipo
  const truthIndexes = [];
  const dareIndexes  = [];

  questions.forEach((q, idx) => {
    if (!q || !q.type) return;
    if (q.type === "VERDAD") {
      truthIndexes.push(idx);
    } else if (q.type === "RETO") {
      dareIndexes.push(idx);
    }
  });

  /* -------------------------
     WEBSOCKET
  -------------------------- */
  const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
  const wsURL = `${wsProtocol}://${location.host}/ws/rooms/{{ room.code }}/`;
  const ws = new WebSocket(wsURL);

  let currentIndex = 0;

  const elStatus   = document.getElementById("room-status");
  const elBox      = document.getElementById("question-box");
  const btnStart   = document.getElementById("btn-start");
  const btnTruth   = document.getElementById("btn-truth");
  const btnDare    = document.getElementById("btn-dare");

  // Escribir sobre el <span> para no romper el dise√±o
  const elQuestionText = elBox ? elBox.querySelector(".question-text") : null;

  function renderQuestion() {
    const target = elQuestionText || elBox;

    if (questions.length && questions[currentIndex]) {
      const q = questions[currentIndex];
      const text = typeof q === "string" ? q : (q.text || JSON.stringify(q));
      target.textContent = text;
    } else {
      target.textContent = `Pregunta #${currentIndex + 1}`;
    }
  }

  function updateTypeButtons() {
    if (!isHost) return;
    if (!btnTruth || !btnDare) return;

    btnTruth.disabled = (truthIndexes.length === 0);
    btnDare.disabled  = (dareIndexes.length === 0);
  }

  /* -------------------------
     COPIAR ENLACE SALA (ROBUSTO)
  -------------------------- */
  const btnCopyLink = document.getElementById("btn-copy-link");

  function fallbackCopy(text) {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.setAttribute("readonly", "");
    ta.style.position = "fixed";
    ta.style.top = "-9999px";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    return ok;
  }

  async function copyRoomLink() {
    const url = window.location.href;

    let copied = false;

    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(url);
        copied = true;
      }
    } catch (e) {
      copied = false;
    }

    if (!copied) {
      copied = fallbackCopy(url);
    }

    if (btnCopyLink) {
      const old = btnCopyLink.innerHTML;
      btnCopyLink.innerHTML = copied
        ? '<span class="btn-icon__emoji">‚úÖ</span>'
        : '<span class="btn-icon__emoji">‚ùå</span>';
      setTimeout(() => (btnCopyLink.innerHTML = old), 900);
    }
  }

  if (btnCopyLink) {
    btnCopyLink.addEventListener("click", copyRoomLink);
  }

  /* -------------------------
     WS EVENTS
  -------------------------- */
  ws.onopen = () => {
    ws.send(JSON.stringify({ action: "join" }));
  };

  ws.onclose = (ev) => {
    console.warn("WS CLOSE", ev.code, ev.reason);
  };

  ws.onerror = (err) => {
    console.error("WS ERROR", err);
  };

  function toggleNavButtons() {
    const live = (elStatus.textContent || "").trim() === "live";

    if (btnTruth) btnTruth.style.display = (isHost ? "inline-block" : "none");
    if (btnDare)  btnDare.style.display  = (isHost ? "inline-block" : "none");

    if (isHost && btnTruth) btnTruth.disabled = !live || truthIndexes.length === 0;
    if (isHost && btnDare)  btnDare.disabled  = !live || dareIndexes.length === 0;
  }

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.event === "state_init") {
      elStatus.textContent = data.status;
      currentIndex = data.index || 0;
      renderQuestion();
      toggleNavButtons();

      if (isHost && btnStart && data.status === "live") {
        btnStart.style.display = "none";
      }
    }

    if (data.event === "new_question") {
      currentIndex = data.index;
      elStatus.textContent = "live";
      renderQuestion();
      toggleNavButtons();

      if (isHost && btnStart) {
        btnStart.style.display = "none";
      }
    }
  };

  /* -------------------------
     LISTENERS (solo host)
  -------------------------- */
  if (isHost && btnStart) {
    btnStart.addEventListener("click", () => {
      ws.send(JSON.stringify({ action: "start" }));
      btnStart.style.display = "none";
      updateTypeButtons();
    });
  }

  function pickRandomIndex(indexArray) {
    if (!indexArray.length) return null;
    const pos = Math.floor(Math.random() * indexArray.length);
    return indexArray[pos];
  }

  if (isHost && btnTruth) {
    btnTruth.addEventListener("click", () => {
      const idx = pickRandomIndex(truthIndexes);
      if (idx === null) return;
      ws.send(JSON.stringify({ action: "next", index: idx }));
    });
  }

  if (isHost && btnDare) {
    btnDare.addEventListener("click", () => {
      const idx = pickRandomIndex(dareIndexes);
      if (idx === null) return;
      ws.send(JSON.stringify({ action: "next", index: idx }));
    });
  }
</script>

{% endblock %}
